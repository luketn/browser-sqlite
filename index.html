<meta charset="utf8" />
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.min.js"></script>
<script>
    config = {
        locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}`
    }
    let dateTime = () => new Date().toDateString() + ":" + new Date().getHours() + ":" + new Date().getMinutes() + ":" + new Date().getSeconds();
    let runQuery = () => {console.log('Not ready to run yet.')};
    let enableRunButton = () => {
        document.getElementById('runButton').disabled = false;
    }

    console.log(`${dateTime()}: Initialising...` );
    const getData = async () => {
        let response = await fetch('https://swapi.dev/api/people');
        let data = await response.json();
        console.log(`${dateTime()}: Loaded ${data.count} people` );

        // The `initSqlJs` function is globally provided by all of the main dist files if loaded in the browser.
        // We must specify this locateFile function if we are loading a wasm file from anywhere other than the current html page's folder.
        initSqlJs(config).then(function(SQL){
            console.log(`${dateTime()}: SQL is loaded`);

            //Create the database
            const db = new SQL.Database();

            // Run a query without reading the results
            db.run("CREATE TABLE people (name char, height int, gender char);");

            // Insert two rows: (1,111) and (2,222)
            for (const person of data.results) {
                db.run("INSERT INTO people VALUES (?,?,?)", [person.name, person.height, person.gender]);
            }

            console.log(`${dateTime()}: Inserted ${data.results.length} people` );

            runQuery = (query) => {
                console.log(`${dateTime()}: Running query: ${query}` );

                // Prepare a statement
                const stmt = db.prepare(query);
                let response = [];
                while(stmt.step()) { //
                    const row = stmt.getAsObject();
                    response.push(row);
                }
                console.log(response);
                document.getElementById('output').innerHTML = JSON.stringify(response, null, 2);
            };

        });
    }
    getData();

</script>
<body>
<textarea id="query" style="height: 240px; width: 640px;">SELECT * FROM people</textarea>
<br/>
<input id="runButton" type="button" value="Run" onclick="runQuery(document.getElementById('query').value)" />
<br/>
<pre id="output" style="background-color: #EBECE4; "></pre>
</body>
</html>
